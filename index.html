<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Work Tracker 2026 - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f172a; 
            color: #f1f5f9;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            min-height: 100px;
            transition: all 0.2s;
        }
        .calendar-day:hover:not(.empty) {
            background-color: #1e293b;
            border-color: #475569;
        }
        .nav-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-100">

    <header class="bg-slate-800 shadow-md z-20 shrink-0 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row gap-4 justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
                    <i class="fa-solid fa-cloud"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-100">Family Tracker <span class="text-blue-500">2026</span></h1>
                    <div id="connectionStatus" class="text-[10px] text-amber-400 flex items-center gap-1">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> Initializing...
                    </div>
                </div>
            </div>

            <div class="flex bg-slate-900 p-1 rounded-xl border border-slate-700">
                <button id="btnCalendarView" onclick="window.switchPage('calendar')" class="nav-btn active px-4 py-1.5 rounded-lg text-sm font-medium transition-all">Calendar</button>
                <button id="btnStatsView" onclick="window.switchPage('stats')" class="nav-btn px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-slate-400">Stats</button>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-auto bg-slate-900 p-4 sm:p-6 relative">
        <!-- Initial Loader Overlay -->
        <div id="mainLoader" class="absolute inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center">
            <div class="spinner mb-4"></div>
            <p class="text-slate-400 text-sm">Connecting to Cloud Storage...</p>
        </div>

        <!-- Pages -->
        <div id="calendarPage" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-slate-800 rounded-xl p-4 flex justify-between items-center border border-slate-700">
                    <button onclick="window.changeMonth(-1)" class="p-2 hover:bg-slate-700 rounded-full transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 class="text-xl font-bold text-white" id="currentMonthDisplay">Month 2026</h2>
                    <button onclick="window.changeMonth(1)" class="p-2 hover:bg-slate-700 rounded-full transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                    <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-bold text-slate-500 uppercase mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-users"></i> Family</h3>
                    <div id="usersList" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="statsPage" class="max-w-7xl mx-auto hidden space-y-6">
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                <h3 class="text-slate-400 text-xs font-bold uppercase mb-4">Daily Distribution</h3>
                <div class="h-64"><canvas id="statsChart"></canvas></div>
            </div>
        </div>
    </main>

    <!-- Modal for Logging -->
    <div id="logModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-800 rounded-2xl w-full max-w-md mx-4 border border-slate-700 p-6">
            <h3 class="text-xl font-bold text-white mb-1">Log Hours</h3>
            <p class="text-blue-400 text-sm mb-4" id="modalUserInfo"></p>
            <div class="space-y-4">
                <input type="number" id="hoursInput" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" placeholder="Hours (e.g. 8)">
                <textarea id="notesInput" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white" placeholder="Notes..."></textarea>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="window.deleteEntry()" id="deleteBtn" class="text-red-400 mr-auto px-4 py-2 hover:bg-red-900/20 rounded-lg hidden">Delete</button>
                <button onclick="window.closeModal()" class="text-slate-400 px-4 py-2">Cancel</button>
                <button onclick="window.saveEntry()" class="bg-blue-600 px-6 py-2 rounded-lg text-white font-bold">Save</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-700 border border-slate-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all z-50">
        <span id="toastMessage">Saved</span>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, deleteField } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const USERS = ['Mohammad', 'Fadwa', 'Alia', 'Tasneem'];
        const COLORS = { 'Mohammad': 'bg-blue-500', 'Fadwa': 'bg-purple-500', 'Alia': 'bg-pink-500', 'Tasneem': 'bg-emerald-500' };
        
        let currentUser = USERS[0];
        let viewDate = new Date();
        let selectedDate = null;
        let appData = {};
        let db, auth;

        // FIXED PATH: 6 segments (even)
        // artifacts / {appId} / public / data / family_store / main
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'family-tracker-2026';

        const getDocRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'family_store', 'main');

        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        document.getElementById('connectionStatus').innerHTML = '<i class="fa-solid fa-circle text-emerald-500"></i> Connected';
                        startSync();
                    }
                });
            } catch (err) {
                console.error("Auth failed", err);
                document.getElementById('connectionStatus').innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i> Auth Error';
            }
        }

        function startSync() {
            onSnapshot(getDocRef(), (snapshot) => {
                document.getElementById('mainLoader').classList.add('hidden');
                if (snapshot.exists()) {
                    appData = snapshot.data();
                }
                // Ensure all user keys exist
                USERS.forEach(u => { if(!appData[u]) appData[u] = {}; });
                refreshUI();
            }, (error) => {
                console.error("Firestore sync error", error);
                document.getElementById('connectionStatus').innerHTML = '<i class="fa-solid fa-wifi text-red-500"></i> Sync Error';
            });
        }

        function refreshUI() {
            renderCalendar();
            renderUsers();
        }

        window.switchPage = (page) => {
            document.getElementById('calendarPage').classList.toggle('hidden', page !== 'calendar');
            document.getElementById('statsPage').classList.toggle('hidden', page !== 'stats');
            document.getElementById('btnCalendarView').classList.toggle('active', page === 'calendar');
            document.getElementById('btnStatsView').classList.toggle('active', page === 'stats');
            if (page === 'stats') renderStats();
        };

        function renderUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            USERS.forEach(u => {
                const isActive = u === currentUser;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer border-2 transition ${isActive ? 'bg-slate-700 border-blue-500' : 'bg-slate-800 border-transparent'}`;
                div.onclick = () => { currentUser = u; renderUsers(); renderCalendar(); };
                div.innerHTML = `<div class="font-bold">${u}</div>`;
                container.appendChild(div);
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('currentMonthDisplay').innerText = `${new Intl.DateTimeFormat('en-US', {month:'long'}).format(viewDate)} ${y}`;
            
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < first; i++) grid.appendChild(document.createElement('div'));

            for (let d = 1; d <= days; d++) {
                const key = formatDateKey(new Date(y, m, d));
                let dots = '';
                USERS.forEach(u => {
                    if (appData[u]?.[key]) dots += `<div class="h-1.5 w-full ${COLORS[u]} rounded-full mb-0.5"></div>`;
                });

                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day bg-slate-800 border border-slate-700 p-1 rounded-md flex flex-col justify-between`;
                dayEl.innerHTML = `<span class="text-xs text-slate-500">${d}</span><div class="mt-1">${dots}</div>`;
                dayEl.onclick = () => openModal(new Date(y, m, d));
                grid.appendChild(dayEl);
            }
        }

        function openModal(date) {
            selectedDate = date;
            const key = formatDateKey(date);
            const entry = appData[currentUser]?.[key];
            document.getElementById('modalUserInfo').innerText = `${currentUser} â€¢ ${date.toLocaleDateString()}`;
            document.getElementById('hoursInput').value = entry ? entry.hours : '';
            document.getElementById('notesInput').value = entry ? (entry.notes || '') : '';
            document.getElementById('deleteBtn').classList.toggle('hidden', !entry);
            document.getElementById('logModal').classList.remove('hidden');
        }

        window.closeModal = () => document.getElementById('logModal').classList.add('hidden');

        window.saveEntry = async () => {
            const hrs = parseFloat(document.getElementById('hoursInput').value);
            const notes = document.getElementById('notesInput').value;
            const key = formatDateKey(selectedDate);
            if (isNaN(hrs)) return;

            try {
                // Nested field update: user.datekey
                await setDoc(getDocRef(), {
                    [currentUser]: { [key]: { hours: hrs, notes } }
                }, { merge: true });
                showToast("Synced!");
                window.closeModal();
            } catch (e) { console.error(e); }
        };

        window.deleteEntry = async () => {
            const key = formatDateKey(selectedDate);
            try {
                await updateDoc(getDocRef(), {
                    [`${currentUser}.${key}`]: deleteField()
                });
                showToast("Removed!");
                window.closeModal();
            } catch (e) { console.error(e); }
        };

        window.changeMonth = (val) => {
            viewDate.setMonth(viewDate.getMonth() + val);
            renderCalendar();
        };

        function formatDateKey(d) {
            return d.toISOString().split('T')[0];
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = m;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 2000);
        }

        init();
    </script>
</body>
</html>
